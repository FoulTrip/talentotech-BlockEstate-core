generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

model User {
    id       String   @id @default(uuid()) @map("_id")
    name     String
    email    String   @unique
    password String
    age      Int
    city     String
    role     UserRole @default(INVESTOR)

    // Blockchain fields (opcional por ahora)
    walletAddress String? @unique
    kycVerified   Boolean @default(false)
    kycProvider   String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    // Relaciones
    investments  Investment[]
    properties   Property[]    @relation("PropertyOwner")
    transactions Transaction[]
    kyc          KYC?
}

enum UserRole {
    INVESTOR
    OWNER
    ADMIN
}

model Property {
    id          String @id @default(uuid()) @map("_id")
    title       String
    description String
    address     String
    city        String
    country     String @default("Colombia")
    latitude    Float?
    longitude   Float?

    // Información financiera
    price          Float
    estimatedValue Float?

    // Tokenización
    totalTokens     Int
    tokenPrice      Float
    availableTokens Int
    tokenSymbol     String?

    // Distribución
    landOwnerPercent Float @default(60)
    poolPercent      Float @default(40)

    // Media
    images         String[]
    documents      String[]
    virtualTourUrl String?

    // Estado
    status PropertyStatus @default(PENDING)

    // Blockchain fields (para futuro)
    contractAddress   String?   @unique
    tokenId           String?
    blockchainNetwork String?   @default("KodeChain")
    txHash            String?
    onChainStatus     Boolean   @default(false)
    lastSyncedAt      DateTime?

    // Relaciones
    ownerId      String
    owner        User                @relation("PropertyOwner", fields: [ownerId], references: [id])
    investments  Investment[]
    transactions Transaction[]
    phases       ConstructionPhase[]
    kyb          KYB?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum PropertyStatus {
    PENDING // En revisión
    APPROVED // Aprobada para tokenización
    TOKENIZING // Generando tokens
    TOKENIZED // Tokens generados
    FUNDING // Buscando inversión
    FUNDED // Inversión completa
    CONSTRUCTION // En construcción
    COMPLETED // Construcción terminada
    RENTING // Generando rentas
    SOLD // Vendida
    CANCELLED // Cancelada
}

model Investment {
    id String @id @default(uuid()) @map("_id")

    userId String
    user   User   @relation(fields: [userId], references: [id])

    propertyId String
    property   Property @relation(fields: [propertyId], references: [id])

    tokensAmount    Int
    tokenPrice      Float
    investmentValue Float // Total invertido
    type            InvestmentType

    status InvestmentStatus @default(ACTIVE)

    // ROI tracking
    totalDividends Float     @default(0)
    lastDividendAt DateTime?

    // Blockchain fields (para futuro)
    walletAddress String?
    txHash        String?
    blockNumber   Int?
    onChain       Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum InvestmentType {
    OWNER_PORTION // Propietario terreno 60%
    POOL_PORTION // Pool Constructor 40%
}

enum InvestmentStatus {
    ACTIVE
    SOLD
    TRANSFERRED
    LOCKED
}

model Transaction {
    id String @id @default(uuid()) @map("_id")

    userId String
    user   User   @relation(fields: [userId], references: [id])

    propertyId String
    property   Property @relation(fields: [propertyId], references: [id])

    type   TransactionType
    amount Float
    tokens Int?
    status TransactionStatus @default(PENDING)

    // Detalles adicionales
    description   String?
    paymentMethod String?
    reference     String? // Referencia de pago externa

    // Blockchain fields (para futuro)
    walletAddress String?
    txHash        String?
    blockNumber   Int?
    gasUsed       Float?
    onChain       Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum TransactionType {
    TOKEN_PURCHASE // Compra de tokens
    TOKEN_SALE // Venta de tokens
    RENTAL_INCOME // Ingreso por renta
    SALE_PROFIT // Ganancia por venta
    CONSTRUCTION_PAYMENT // Pago de construcción
    DIVIDEND // Dividendo
    REFUND // Reembolso
    FEE // Comisión de plataforma
}

enum TransactionStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
    REFUNDED
    CANCELLED
}

model ConstructionPhase {
    id         String   @id @default(uuid()) @map("_id")
    propertyId String
    property   Property @relation(fields: [propertyId], references: [id])

    name        String
    description String
    order       Int
    status      PhaseStatus @default(PENDING)

    // Presupuesto
    estimatedCost Float
    actualCost    Float?

    // Fechas
    estimatedStartDate DateTime?
    estimatedEndDate   DateTime?
    actualStartDate    DateTime?
    actualEndDate      DateTime?

    // Progreso
    progressPercent Int @default(0)

    // Media
    images    String[]
    documents String[]

    // Pagos
    paymentReleased Boolean   @default(false)
    paymentDate     DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum PhaseStatus {
    PENDING
    IN_PROGRESS
    COMPLETED
    DELAYED
    CANCELLED
}

model Ecosystem {
    id String @id @default(uuid()) @map("_id")

    name        String
    type        EcosystemType
    description String
    url         String?

    // Integraciones
    apiKey     String?
    apiSecret  String?
    webhookUrl String?
    isActive   Boolean @default(true)

    // Configuración
    config String? // JSON stringificado

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum EcosystemType {
    REAL_ESTATE_PLATFORM
    PAYMENT_GATEWAY
    BLOCKCHAIN
    IDENTITY_VERIFICATION
    MARKETPLACE
    BANK
    NOTARY
}

model BlockchainSync {
    id         String     @id @default(uuid()) @map("_id")
    entityType EntityType // Tipo de entidad
    entityId   String // ID de la entidad

    // Blockchain info
    txHash      String?
    blockNumber Int?
    network     String? // ethereum, polygon, etc.

    // Estado
    status       SyncStatus
    errorMessage String?
    retryCount   Int        @default(0)

    // Metadata
    metadata String? // JSON con datos adicionales

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()

    @@index([entityType, entityId])
}

enum EntityType {
    PROPERTY
    INVESTMENT
    TRANSACTION
    USER
}

enum SyncStatus {
    PENDING
    SYNCING
    SYNCED
    FAILED
    SKIPPED
}

model PlatformConfig {
    id    String @id @default(uuid()) @map("_id")
    key   String @unique
    value String

    description String?
    isPublic    Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

model Notification {
    id     String @id @default(uuid()) @map("_id")
    userId String

    title   String
    message String
    type    NotificationType

    // Relacionado
    entityType String?
    entityId   String?

    // Estado
    read   Boolean   @default(false)
    readAt DateTime?

    createdAt DateTime @default(now())
}

enum NotificationType {
    INVESTMENT
    TRANSACTION
    PROPERTY_UPDATE
    CONSTRUCTION_UPDATE
    DIVIDEND_PAYMENT
    KYC_UPDATE
    SYSTEM
}

// KYC - Know Your Customer (Verificación de usuarios)
model KYC {
    id     String @id @default(uuid()) @map("_id")
    userId String @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Documentos de identidad
    idCardFrontImage String? // URL de foto frontal de cédula
    idCardBackImage  String? // URL de foto trasera de cédula
    selfieImage      String? // URL de selfie para verificación biométrica

    // Información de identificación
    idNumber     String? // Número de identificación
    idType       String?   @default("CC") // CC, CE, Pasaporte, etc.
    fullName     String? // Nombre completo según documento
    dateOfBirth  DateTime?
    placeOfBirth String?
    nationality  String?
    occupation   String?
    address      String?
    phone        String?

    // Estado de verificación
    status           KYCStatus @default(PENDING)
    verificationDate DateTime?
    verifiedBy       String? // ID del admin que verificó
    rejectionReason  String? // Razón de rechazo si aplica

    // Verificación biométrica
    biometricScore     Float? // Score de verificación facial
    livenessCheck      Boolean @default(false)
    documentValidation Boolean @default(false)

    // Información adicional
    riskLevel   RiskLevel @default(MEDIUM)
    notes       String? // Notas del verificador
    ipAddress   String?
    userAgent   String?
    geolocation String?

    // Metadata
    submittedAt DateTime?
    expiresAt   DateTime? // Fecha de expiración de la verificación

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum KYCStatus {
    PENDING // Pendiente de envío
    SUBMITTED // Enviado para revisión
    IN_REVIEW // En revisión
    APPROVED // Aprobado
    REJECTED // Rechazado
    EXPIRED // Expirado
    RESUBMIT_REQUIRED // Requiere reenvío
}

enum RiskLevel {
    LOW
    MEDIUM
    HIGH
    VERY_HIGH
}

// KYB - Know Your Business (Verificación de propiedades)
model KYB {
    id         String   @id @default(uuid()) @map("_id")
    propertyId String   @unique
    property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

    // Documentos legales de la propiedad
    libertadYTradicion   String? // Certificado de libertad y tradición
    escrituraPublica     String? // Escritura pública
    cedulaCatastral      String? // Cédula catastral
    predialCertificate   String? // Certificado de paz y salvo predial
    valoracionComercial  String? // Avalúo comercial
    planos               String? // Planos arquitectónicos
    licenciaConstruccion String? // Licencia de construcción (si aplica)
    usoSuelo             String? // Certificado de uso de suelo
    serviciosPublicos    String? // Certificados de servicios públicos

    // Documentos del propietario legal
    ownerIdDocument   String? // Documento de identidad del propietario
    powerOfAttorney   String? // Poder notarial (si aplica)
    taxIdentification String? // RUT o identificación fiscal
    bankAccountProof  String? // Certificación bancaria

    // Información fiscal y financiera
    taxId              String? // NIT o identificación tributaria
    taxRegime          String? // Régimen tributario
    lastTaxDeclaration String? // Última declaración de renta
    propertyTaxStatus  String? // Estado del impuesto predial

    // Verificación de propiedad
    cadastralNumber   String? // Matrícula inmobiliaria
    propertyRegistry  String? // Registro de la propiedad
    ownershipVerified Boolean @default(false)
    encumbrances      String? // Gravámenes o limitaciones

    // Estado de verificación
    status           KYBStatus @default(PENDING)
    verificationDate DateTime?
    verifiedBy       String? // ID del admin que verificó
    rejectionReason  String? // Razón de rechazo si aplica

    // Due Diligence
    dueDiligenceReport  String? // Informe de due diligence
    legalOpinion        String? // Opinión legal
    environmentalReport String? // Informe ambiental (si aplica)
    structuralReport    String? // Informe estructural
    appraisalValue      Float? // Valor del avalúo
    appraisalDate       DateTime?
    appraiserLicense    String? // Licencia del avaluador

    // Información adicional
    riskLevel         RiskLevel @default(MEDIUM)
    complianceScore   Float? // Score de cumplimiento normativo
    notes             String? // Notas del verificador
    documentsComplete Boolean   @default(false)
    legalVerified     Boolean   @default(false)
    financialVerified Boolean   @default(false)
    technicalVerified Boolean   @default(false)

    // Metadata
    submittedAt DateTime?
    expiresAt   DateTime? // Fecha de expiración de la verificación (ej: 1 año)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt()
}

enum KYBStatus {
    PENDING // Pendiente de envío
    SUBMITTED // Enviado para revisión
    IN_REVIEW // En revisión
    APPROVED // Aprobado
    REJECTED // Rechazado
    EXPIRED // Expirado
    RESUBMIT_REQUIRED // Requiere reenvío
    CONDITIONAL_APPROVAL // Aprobación condicional
}
